# Настройка почты для домена uniformfactory.ru

## Проблема
Письма возвращаются с ошибкой: `Connection timed out` при попытке доставить на `mail@uniformfactory.ru`

**Причина:** MX записи домена не настроены для приема входящих писем через Яндекс.

---

## Решение: Настройка MX записей для Яндекс.Почты

### Шаг 1: Зайдите в панель управления DNS вашего домена
Это может быть:
- Регистратор домена (где вы купили домен)
- Хостинг-провайдер
- Отдельный DNS-сервис (Cloudflare, AWS Route53 и т.д.)

### Шаг 2: Добавьте MX записи для Яндекс.Почты

Удалите все существующие MX записи и добавьте следующие:

| Тип | Имя/Хост | Значение | Приоритет | TTL |
|-----|----------|----------|-----------|-----|
| MX | @ или пусто | mx.yandex.net. | 10 | 3600 |

**Важно:** 
- Точка в конце `mx.yandex.net.` обязательна!
- Если есть несколько MX записей, удалите их все
- Приоритет: 10 (меньше = выше приоритет)

### Шаг 3: Добавьте SPF запись (защита от спама)

| Тип | Имя/Хост | Значение |
|-----|----------|----------|
| TXT | @ или пусто | `v=spf1 include:_spf.yandex.net ~all` |

### Шаг 4: Добавьте DKIM запись (если используете)

Если у вас настроен DKIM в Яндекс.Почте:

1. Войдите в админ-панель Яндекс.Почты для домена
2. Перейдите в раздел DKIM
3. Скопируйте предоставленную запись
4. Добавьте её как TXT запись в DNS

### Шаг 5: Проверка настроек

После добавления записей подождите 1-24 часа (время распространения DNS).

Проверить MX записи можно здесь:
- https://mxtoolbox.com/SuperTool.aspx?action=mx%3auniformfactory.ru
- https://www.whatsmydns.net/#MX/uniformfactory.ru

---

## Текущая конфигурация приложения

### Backend Email Service (/app/backend/email_service.py)
```python
SMTP_SERVER = "smtp.yandex.ru"
SMTP_PORT = 465
SENDER_EMAIL = env переменная
EMAIL_PASSWORD = env переменная
```

### Переменные окружения (/app/backend/.env)
```
SENDER_EMAIL=ваш-email@yandex.ru
EMAIL_PASSWORD=пароль-приложения
ADMIN_EMAIL=mail@uniformfactory.ru
```

---

## Проверка после настройки

### 1. Проверить MX записи:
```bash
# Linux/Mac
dig uniformfactory.ru MX

# Windows
nslookup -type=MX uniformfactory.ru
```

Должно вернуться:
```
uniformfactory.ru.  3600  IN  MX  10 mx.yandex.net.
```

### 2. Отправить тестовое письмо
Отправьте письмо на `mail@uniformfactory.ru` с любого email-адреса.

### 3. Проверить, что письмо дошло
Войдите в почту `mail@uniformfactory.ru` на Яндексе и проверьте входящие.

---

## Частые ошибки

### ❌ Ошибка: "Connection timed out"
**Причина:** MX записи не настроены или указывают на неправильный сервер  
**Решение:** Добавьте MX запись `mx.yandex.net.` с приоритетом 10

### ❌ Ошибка: "550 5.7.1 Relay access denied"
**Причина:** SPF запись не настроена  
**Решение:** Добавьте TXT запись с SPF

### ❌ Письма попадают в спам
**Причина:** Нет DKIM подписи  
**Решение:** Настройте DKIM в Яндекс.Почте и добавьте DKIM запись в DNS

---

## Альтернативное решение: Использование другого email для админа

Если вы не хотите настраивать MX записи, можно временно использовать другой email:

1. Откройте `/app/backend/.env`
2. Измените `ADMIN_EMAIL` на существующий email (например, alaver79@yandex.ru)
3. Перезапустите backend: `sudo supervisorctl restart backend`

---

## Полезные ссылки

- [Яндекс.Почта для домена](https://connect.yandex.ru/)
- [Инструкция по настройке MX от Яндекса](https://yandex.ru/support/domain/set-mail/mx.html)
- [Проверка MX записей](https://mxtoolbox.com/)
- [Проверка SPF](https://www.kitterman.com/spf/validate.html)

---

## Текущий статус

✅ Исходящая почта работает (SMTP через Яндекс)  
❌ Входящая почта НЕ работает (нет MX записей)  
⏳ Требуется настройка MX записей в DNS

После настройки MX записей проблема с возвратом писем будет решена.
